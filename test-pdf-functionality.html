<!DOCTYPE html>
<html>
<head>
    <title>Test PDF Functionality</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD2WtLJvzBUnOxLZjZk1fSSQKkXyMwfxUk",
            authDomain: "crednxt-ef673.firebaseapp.com",
            projectId: "crednxt-ef673",
            storageBucket: "crednxt-ef673.appspot.com",
            messagingSenderId: "447736552285",
            appId: "1:447736552285:web:d5a3f8b4c2e1a9f6e7b8c9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Create a test user and offer for PDF testing
        window.testPDFFlow = async () => {
            console.log('üß™ Starting complete PDF test flow...');
            
            try {
                // Step 1: Create test user
                const testEmail = `test-${Date.now()}@example.com`;
                const testPassword = 'TestPassword123!';
                
                console.log('üë§ Creating test user:', testEmail);
                const userCredential = await createUserWithEmailAndPassword(auth, testEmail, testPassword);
                const user = userCredential.user;
                console.log('‚úÖ Test user created:', user.uid);
                
                // Step 2: Get ID token
                const token = await user.getIdToken();
                console.log('üé´ Token obtained:', token.substring(0, 30) + '...');
                
                // Step 3: Create a test offer
                console.log('üìù Creating test offer...');
                const offerData = {
                    fromUserId: user.uid,
                    toUserId: user.uid, // Self-offer for testing
                    amount: 10000,
                    interestRate: 12,
                    tenure: 12,
                    purpose: 'PDF Test Loan',
                    status: 'pending'
                };
                
                const createResponse = await fetch('https://api-mzz6re522q-uc.a.run.app/offers', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(offerData)
                });
                
                console.log('üìù Create offer response:', createResponse.status);
                if (!createResponse.ok) {
                    const errorText = await createResponse.text();
                    console.error('‚ùå Failed to create offer:', errorText);
                    return;
                }
                
                const offer = await createResponse.json();
                console.log('‚úÖ Test offer created:', offer.id);
                
                // Step 4: Test PDF download
                console.log('üìÑ Testing PDF download...');
                const pdfResponse = await fetch(`https://api-mzz6re522q-uc.a.run.app/offers/${offer.id}/pdf/contract`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/pdf'
                    }
                });
                
                console.log('üìÑ PDF response status:', pdfResponse.status);
                console.log('üìÑ PDF response headers:', pdfResponse.headers.get('content-type'));
                
                if (pdfResponse.ok) {
                    console.log('üéâ PDF download SUCCESS! Size:', pdfResponse.headers.get('content-length'), 'bytes');
                    
                    // Download the PDF
                    const pdfBlob = await pdfResponse.blob();
                    const url = window.URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `test-contract-${offer.id}.pdf`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    
                } else {
                    const errorText = await pdfResponse.text();
                    console.error('‚ùå PDF download failed:', errorText);
                }
                
                // Step 5: Cleanup
                console.log('üßπ Cleaning up test user...');
                await user.delete();
                console.log('‚úÖ Test completed and cleaned up');
                
            } catch (error) {
                console.error('‚ùå Test failed:', error);
            }
        };

        // Test with existing authentication
        window.testExistingAuth = async () => {
            const user = auth.currentUser;
            if (!user) {
                console.log('‚ùå No user logged in. Please login first at https://crednxt-ef673.web.app');
                return;
            }
            
            console.log('üë§ Testing with current user:', user.uid);
            
            try {
                const token = await user.getIdToken();
                console.log('üé´ Token obtained for existing user');
                
                // List user's offers first
                const offersResponse = await fetch('https://api-mzz6re522q-uc.a.run.app/offers', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!offersResponse.ok) {
                    console.error('‚ùå Failed to fetch offers:', await offersResponse.text());
                    return;
                }
                
                const offers = await offersResponse.json();
                console.log('üìã User has', offers.length, 'offers');
                
                if (offers.length === 0) {
                    console.log('üí° No offers found. Create an offer first at https://crednxt-ef673.web.app');
                    return;
                }
                
                // Test PDF with first offer
                const firstOffer = offers[0];
                console.log('üìÑ Testing PDF with offer:', firstOffer.id);
                
                const pdfResponse = await fetch(`https://api-mzz6re522q-uc.a.run.app/offers/${firstOffer.id}/pdf/contract`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/pdf'
                    }
                });
                
                console.log('üìÑ PDF response:', pdfResponse.status);
                if (pdfResponse.ok) {
                    console.log('üéâ PDF download works!');
                    const pdfBlob = await pdfResponse.blob();
                    const url = window.URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `contract-${firstOffer.id}.pdf`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    const errorText = await pdfResponse.text();
                    console.error('‚ùå PDF failed:', errorText);
                }
                
            } catch (error) {
                console.error('‚ùå Test error:', error);
            }
        };
    </script>
</head>
<body>
    <h1>PDF Functionality Test</h1>
    <p><strong>Option 1:</strong> <button onclick="testPDFFlow()">Complete Test (Creates temp user & offer)</button></p>
    <p><strong>Option 2:</strong> <button onclick="testExistingAuth()">Test with Existing User</button></p>
    <p><em>For Option 2: First login at <a href="https://crednxt-ef673.web.app" target="_blank">your app</a>, then come back and click the button</em></p>
    <p><strong>Check browser console for detailed results</strong></p>
</body>
</html>