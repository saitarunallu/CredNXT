<!DOCTYPE html>
<html>
<head>
    <title>PDF Download Test</title>
</head>
<body>
    <h1>PDF Download Test</h1>
    <button id="testSchedule">Test Schedule Download</button>
    <button id="testContract">Test Contract Download</button>
    <button id="testKFS">Test KFS Download</button>
    <div id="output"></div>

    <script>
        const output = document.getElementById('output');
        
        function log(message) {
            output.innerHTML += `<p>${message}</p>`;
            console.log(message);
        }
        
        async function testDownload(endpoint, fileName) {
            log(`Testing ${endpoint}...`);
            
            try {
                // Use a real offer ID that exists
                const offerId = 'E4Fa8yRP51ebjcBAXfEE'; // We know this has PDFs
                const token = localStorage.getItem('firebase_auth_token') || localStorage.getItem('auth_token');
                
                log(`Token exists: ${!!token}`);
                
                const response = await fetch(`/api/offers/${offerId}/${endpoint}`, {
                    credentials: 'include',
                    headers: {
                        'Authorization': `Bearer ${token || 'no-token'}`
                    }
                });
                
                log(`Response status: ${response.status}`);
                log(`Response headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()))}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    log(`Blob size: ${blob.size} bytes`);
                    log(`Blob type: ${blob.type}`);
                    
                    if (blob.size > 0) {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = fileName;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        log(`✅ Download successful: ${fileName}`);
                    } else {
                        log(`❌ Empty file received`);
                    }
                } else {
                    const errorText = await response.text();
                    log(`❌ Error: ${response.status} - ${errorText}`);
                }
            } catch (error) {
                log(`❌ Exception: ${error.message}`);
            }
        }
        
        document.getElementById('testSchedule').onclick = () => {
            testDownload('schedule/download', 'test-schedule.pdf');
        };
        
        document.getElementById('testContract').onclick = () => {
            testDownload('contract', 'test-contract.pdf');
        };
        
        document.getElementById('testKFS').onclick = () => {
            testDownload('kfs', 'test-kfs.pdf');
        };
        
        // Auto-populate token for testing
        if (!localStorage.getItem('firebase_auth_token')) {
            log('No auth token found. Please login first.');
        } else {
            log('Auth token found, ready to test downloads.');
        }
    </script>
</body>
</html>